<!doctype html><html lang="zh-CN"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä»ªå¼è¿›è¡Œä¸­ Â· æƒ…ç»ªåšç‰©é¦†ï¼ˆv4.7ï¼‰</title>
<link rel="stylesheet" href="styles.css">
<style>
.scene{position:relative;min-height:100vh;border-radius:16px;overflow:hidden;background:#0b0f1a;}
.star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;opacity:var(--o,.7);
  animation:twinkle 2.4s ease-in-out infinite, drift var(--spd,12s) linear infinite;}
@keyframes twinkle{0%,100%{opacity:.25}50%{opacity:1}}
@keyframes drift{from{transform:translate3d(0,0,0)} to{transform:translate3d(-60vw,40vh,0)}}
.meteor{position:absolute;width:2px;height:2px;background:transparent;
  box-shadow:0 0 6px 2px rgba(255,255,255,.95);transform:rotate(320deg);
  animation:shoot 1.6s linear forwards;}
@keyframes shoot{0%{opacity:0;transform:translate(100vw,-10vh) rotate(320deg)}
10%{opacity:1}100%{opacity:0;transform:translate(-10vw,60vh) rotate(320deg)}}
.hint-overlay{position:fixed;inset:0;background:rgba(0,0,0,.50);display:flex;align-items:center;justify-content:center;z-index:9999}
.hint-card{background:#0f1117;border:1px solid #2a3042;border-radius:16px;padding:16px;max-width:480px;color:#eaeef5;text-align:center;max-height:72vh;overflow:auto}
.hint-title{font-size:18px;margin:2px 0 8px}
.hint-text{font-size:14px;color:#aab3cf;margin-bottom:12px}
.hint-row{display:flex;gap:10px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
.hint-row button{min-width:150px}
.actions{position:fixed;left:12px;right:12px;bottom:max(12px,env(safe-area-inset-bottom));display:flex;flex-wrap:wrap;gap:10px;justify-content:center;z-index:5}
.actions>button{flex:1 1 160px;min-height:40px;white-space:nowrap}
.small{font-size:12px;color:#aab3cf}
</style>
</head>
<body>
<main class="container">
  <div class="card">
    <div id="scene" class="scene">
      <!-- å¼€åœºé®ç½© -->
      <div id="hint" class="hint-overlay" onclick="if(event.target.id==='hint')__start(event)">
        <div class="hint-card" onclick="event.stopPropagation()">
          <div class="hint-title">å‡†å¤‡å¼€å§‹</div>
          <div class="hint-text">ç‚¹ç©ºç™½å¤„æˆ–â€œå¼€å§‹â€æˆæƒéŸ³é¢‘ï¼›å®‰å“/å¾®ä¿¡è¯·å…ˆç‚¹ä¸€æ¬¡â€œè¯•å¬â€å†å¼€å§‹</div>
          <div class="hint-row">
            <button onclick="__beep(event)">è¯•å¬å¥³ç”Ÿ</button>
            <button onclick="__beep(event)">è¯•å¬ç”·ç”Ÿ</button>
            <button id="recBtn" onclick="__toggleRec(event)">ğŸ™ï¸ å½•éŸ³æˆ‘çš„åŸå£°ï¼ˆä¸Šé™30ç§’ï¼‰</button>
          </div>
          <div id="recInfo" class="small" style="display:none"></div>
          <button id="startPlay" class="primary" onclick="__start(event)">å¼€å§‹</button>
          <div class="small" style="margin-top:6px">è¯´æ˜ï¼šå½•éŸ³ä»…ä¿å­˜åœ¨æœ¬æœºï¼Œä¸ä¸Šä¼ </div>
        </div>
      </div>

      <div class="badge" id="badge"></div>
      <div class="countdown" id="countdown">--:--</div>
      <div class="marquee" id="marquee"></div>

      <div class="actions">
        <button id="pause" onclick="__pause()">æš‚åœ</button>
        <button id="finish" onclick="__finishNow()">æå‰ç»“æŸ</button>
        <button id="shareLanding" class="secondary" onclick="__shareLanding()">é‚€è¯·å¥½å‹æ¥ç©</button>
        <button id="shareReplay"  class="secondary" onclick="__shareReplay()">åˆ†äº«å®Œæ•´æµç¨‹</button>
        <button id="tipBtn"       class="secondary" onclick="__tip()">æ‰“èµæ”¯æŒ</button>
      </div>
    </div>
    <p class="muted center">è‹¥æ²¡æœ‰å£°éŸ³ï¼šå…ˆç‚¹â€œè¯•å¬â€æˆ–ç©ºç™½å¤„ï¼›iPhone è¯·å…³é—­æœºèº«é™éŸ³é”®ã€‚</p>
  </div>
</main>
<footer class="footer">Â© æƒ…ç»ªåšç‰©é¦†</footer>

<!-- æ‰“èµå¼¹å±‚ / åˆ†äº«å¼¹å±‚ï¼šå¤ç”¨ä½ ä»“åº“æ ·å¼ï¼ˆç•¥ï¼‰ -->
<style>
.tip-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999}
.tip-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px 16px 12px;max-width:440px;color:#eaeef5}
.tip-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tip-box{border:1px dashed #394058;border-radius:12px;min-height:180px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tip-box img{max-width:100%;max-height:240px;display:block}
.tip-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
.share-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.share-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px;max-width:480px;color:#eaeef5}
.share-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.share-box{border:1px dashed #394058;border-radius:12px;min-height:160px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
</style>
<div id="tipModal" class="tip-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="tip-card">
    <h3>æ‰“èµæ”¯æŒï¼ˆè°¢è°¢ä½ ï¼‰</h3>
    <div class="tip-grid">
      <div class="tip-box">
        <img id="wxQR" src="assets/tip_wechat.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">æ”¾å…¥<br>assets/tip_wechat.jpg</div>
      </div>
      <div class="tip-box">
        <img id="aliQR" src="assets/tip_alipay.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">æ”¾å…¥<br>assets/tip_alipay.jpg</div>
      </div>
    </div>
    <div class="tip-actions">
      <button class="secondary" onclick="document.getElementById('tipModal').style.display='none'">å…³é—­</button>
    </div>
  </div>
</div>
<div id="shareModal" class="share-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="share-card">
    <h3 id="shareTitle">åˆ†äº«é“¾æ¥</h3>
    <div class="share-grid">
      <div class="share-box" style="padding:10px">
        <input id="shareInput" readonly style="width:100%;padding:10px;border-radius:8px;background:#0d0f18;color:#eaeef5;border:1px solid #2a3042">
        <p class="small" style="margin-top:8px">é•¿æŒ‰æˆ–ç‚¹â€œå¤åˆ¶â€</p>
        <div class="share-actions" style="justify-content:flex-start">
          <button class="secondary" onclick="__copyShare()">å¤åˆ¶</button>
        </div>
      </div>
      <div class="share-box">
        <img id="shareQR" alt="äºŒç»´ç ">
        <div id="qrFallback" class="small" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center">äºŒç»´ç åŠ è½½å¤±è´¥ï¼Œè¯·å…ˆå¤åˆ¶é“¾æ¥</div>
      </div>
    </div>
    <div id="statsLine" class="small" style="margin-top:10px;text-align:center">ç´¯è®¡è§‚çœ‹ï¼š-- æ¬¡ Â· å®Œæ’­ï¼š-- æ¬¡ Â· æ‰“èµç‚¹å‡»ï¼š-- æ¬¡</div>
    <div class="share-actions">
      <button class="secondary" onclick="document.getElementById('shareModal').style.display='none'">å…³é—­</button>
    </div>
  </div>
</div>

<script>
function $(id){return document.getElementById(id)}
function parseData(){try{const raw=(location.hash||'').slice(1);if(!raw)return null;const b64=raw.split('&')[0];return JSON.parse(decodeURIComponent(escape(atob(b64))))}catch(e){return null}}
const data=parseData(); if(!data){ document.body.innerHTML='<div class="container"><div class="card">æ•°æ®ä¸¢å¤±ï¼Œè¯·è¿”å›å…¥å£</div></div>'; throw new Error('no data'); }
const key=String(data.ts), cid=(data.cid||String(data.ts)), id=key.slice(-6), isReplay=(location.hash||'').includes('view=1');
const NS='muse-ritual';
function bump(n){try{fetch('https://api.countapi.xyz/hit/'+NS+'/'+encodeURIComponent(n))}catch(e){}}
async function readC(n){try{const r=await fetch('https://api.countapi.xyz/get/'+NS+'/'+encodeURIComponent(n));const j=await r.json();return j&&typeof j.value==='number'?j.value:0}catch(e){return 0}}

(function(){const d=document.createElement('div');d.id='soundDot';d.style.cssText='position:fixed;right:8px;top:8px;width:10px;height:10px;border-radius:50%;background:#f55;opacity:.9;z-index:99999';document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(d));})();
function setDot(ok){const d=$('soundDot');if(d)d.style.background=ok?'#2ecc71':'#f55'}

const badgeEl=$('badge'), cdEl=$('countdown'), mqEl=$('marquee');
badgeEl.textContent='ä¸º '+(data.yourName||'ä½ ')+' ä¸ '+(data.aiName||'TA')+' çš„ä»ªå¼ Â· NO.'+id;
mqEl.textContent=data.letter||'ï¼ˆåœ¨è¿™é‡Œï¼Œå¯¹è¿‡å»çš„è‡ªå·±æ¸©æŸ”åœ°é“ä¸€å£°å†è§â€¦ï¼‰';

/* èƒŒæ™¯ + æµæ˜Ÿ */
(function(){
  const scene=$('scene');
  const custom = data.bgImageUrl || (function(){try{return sessionStorage.getItem('bg_'+key)||''}catch(_){return ''}})();
  if(custom){ scene.style.background='linear-gradient(to bottom, rgba(24,26,36,.30), rgba(24,26,36,.40)), url("'+custom+'") center/cover no-repeat'; }
  const n=160; for(let i=0;i<n;i++){ const s=document.createElement('div'); s.className='star'; s.style.left=(Math.random()*120-10)+'vw'; s.style.top=(Math.random()*100)+'%'; s.style.setProperty('--spd',(9+Math.random()*13)+'s'); s.style.setProperty('--o',(0.45+Math.random()*0.5).toFixed(2)); scene.appendChild(s);}
  function meteor(){const m=document.createElement('div');m.className='meteor';m.style.left='100vw';m.style.top=(Math.random()*25)+'vh';scene.appendChild(m);setTimeout(()=>m.remove(),1700);setTimeout(meteor,3000+Math.random()*4000);} setTimeout(meteor,1500);
})();

/* å£°éŸ³æ± /æš‚åœ */
const AUD=new Set();
function addTrack(el){ if(!el) return; AUD.add(el); el.addEventListener('ended',()=>AUD.delete(el)); }
function pauseAll(){ AUD.forEach(a=>{try{!a.paused&&a.pause()}catch(_){}}); try{speechSynthesis&&speechSynthesis.pause&&speechSynthesis.pause()}catch(_){} }
function resumeAll(){ AUD.forEach(a=>{try{a.paused&&a.play()}catch(_){}}); try{speechSynthesis&&speechSynthesis.resume&&speechSynthesis.resume()}catch(_){} }

/* è§£é” + è¯•å¬ */
function __unlock(){
  try{const AC=window.AudioContext||window.webkitAudioContext;if(AC){const ctx=new AC();ctx.resume&&ctx.resume();const b=ctx.createBuffer(1,1,22050),src=ctx.createBufferSource();src.buffer=b;src.connect(ctx.destination);src.start(0);}}catch(_){}
  try{const a=new Audio();a.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBIAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=';a.muted=true;a.playsInline=true;a.play().then(()=>{a.pause();setDot(true);}).catch(()=>{});}catch(_){}
}
function __beep(ev){ev&&ev.stopPropagation();__unlock(); try{const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return;const ctx=new AC();const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=880;g.gain.value=0.25;o.connect(g).connect(ctx.destination);o.start();setDot(true);setTimeout(()=>{try{o.stop();ctx.close&&ctx.close();}catch(_){}},180);}catch(_){}}

/* BGMï¼šä¿ç•™å¼•ç”¨ä»¥ä¾¿å‹ä½/æ¢å¤ */
let bgmEl=null, bgmTarget=(typeof data.bgmVol==='number'?data.bgmVol:0.28);
function duck(on){
  if(!bgmEl) return;
  const to = on ? Math.max(0, bgmTarget*0.35) : bgmTarget;
  const step=(to-(bgmEl.volume||0))/8; let n=8;
  clearInterval(bgmEl.__duckT);
  bgmEl.__duckT=setInterval(()=>{n--; try{bgmEl.volume=Math.max(0,Math.min(1,(bgmEl.volume||0)+step))}catch(_){ } if(n<=0) clearInterval(bgmEl.__duckT);},90);
}

/* æ ¸å¿ƒæ’­æ”¾å™¨ï¼šä¼˜å…ˆ audioï¼Œå¤±è´¥å† videoï¼›å¿…è¦æ—¶æŠ“å–æˆ blob:URL */
const mediaBin=document.createElement('div'); mediaBin.style.cssText='position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden;z-index:-1'; document.body.appendChild(mediaBin);
async function playTag(tag,src,{loop=false,volume=1}={}){
  return new Promise(async(resolve,reject)=>{
    const el=document.createElement(tag); el.src=src; el.playsInline=true; el.controls=false; el.loop=!!loop; el.muted=false; el.preload='auto'; el.volume=volume;
    if(tag==='video'){ el.setAttribute('playsinline',''); el.setAttribute('webkit-playsinline',''); el.style.width='1px'; el.style.height='1px'; }
    mediaBin.appendChild(el); addTrack(el);
    el.onended=()=>{ try{mediaBin.removeChild(el)}catch(_){ } resolve(true);};
    el.onerror=()=>{ try{mediaBin.removeChild(el)}catch(_){ } reject(new Error('error'));};
    try{ await el.play(); }catch(e){ try{mediaBin.removeChild(el)}catch(_){ } reject(e); }
  });
}
async function fetchBlobURL(src){
  try{ const r=await fetch(src,{mode:'cors'}); if(!r.ok) throw new Error('net'); const b=await r.blob(); return URL.createObjectURL(b); }catch(e){ return null; }
}
async function playOne(src,{loop=false,volume=1}={}){
  if(!src) return false;
  const ext=(src.split('?')[0].split('#')[0].split('.').pop()||'').toLowerCase();
  const likelyVideo = /(^https?:\/\/.*\/video\/upload\/)|\b(mp4|mov|m4v)\b/.test(src);
  try{ if(!likelyVideo){ await playTag('audio',src,{loop,volume}); return true; } }catch(_){}
  try{ await playTag('video',src,{loop,volume}); return true; }catch(_){}
  const blob=await fetchBlobURL(src);
  if(blob){ try{ if(!likelyVideo){ await playTag('audio',blob,{loop,volume}); return true; } }catch(_){}
             try{ await playTag('video',blob,{loop,volume}); return true; }catch(_){ } }
  return false;
}

/* èµ„æºé€‰æ‹©ï¼ˆURL â†’ sessionStorage â†’ èµ„äº§ï¼‰ */
function ss(k){try{return sessionStorage.getItem(k)||''}catch(_){return ''}}
async function firstPlayable(list,opt={}){ for(const u of list){ if(!u) continue; if(await playOne(u,opt)) return true; } return false; }

/* é¢„çƒ­ & BGM æ¸å…¥ */
async function startBGM(){
  const cands=[ data.bgmUrl, ss('bgm_'+key), 'assets/bgm_default.m4a','assets/bgm_default.mp3','assets/bgm_default.ogg','assets/bgm_default.wav' ];
  // ç”¨çœŸæ­£çš„ <audio> æ’­æ”¾ï¼ˆä¸åšé¢„çƒ­ï¼Œç›´æ¥æ¸å…¥ï¼‰
  for(const u of cands){
    if(!u) continue;
    try{
      const a=document.createElement('audio'); a.src=u; a.playsInline=true; a.loop=true; a.volume=0.001; a.preload='auto';
      mediaBin.appendChild(a); addTrack(a); bgmEl=a;
      await a.play().catch(()=>{throw 1});
      let n=14,step=(bgmTarget-a.volume)/n; const id=setInterval(()=>{n--; try{a.volume=Math.min(bgmTarget,(a.volume||0)+step)}catch(_){ } if(n<=0) clearInterval(id); },120);
      return true;
    }catch(_){ try{bgmEl&&mediaBin.removeChild(bgmEl)}catch(__){} bgmEl=null; }
  }
  return false;
}

/* TTSï¼šåŠ ç¼“å†²ï¼Œç»™æš‚åœé”®å¯æ§ */
async function speakTTS(text,pref){
  const synth=window.speechSynthesis; if(!synth || !text) return;
  try{synth.resume&&synth.resume();}catch(_){}
  await new Promise(r=>setTimeout(r,100));
  function pick(){ const vs=synth.getVoices()||[]; const want=(pref==='male')?['Tao','Daniel','Alex','Google US English','Google Mandarin']:['Xiaoxiao','Xiaoyi','Yating','Samantha','Google ä¸­æ–‡','Google Mandarin']; for(const w of want){const hit=vs.find(v=>(v.name||'').toLowerCase().includes(w.toLowerCase())); if(hit) return hit;} return vs[0]||null;}
  const u=new SpeechSynthesisUtterance(text), v=pick(); if(v){u.voice=v;u.lang=v.lang||'zh-CN'} else u.lang='zh-CN';
  u.rate=(pref==='male'?0.95:0.98); u.pitch=(pref==='male'?0.96:1.04);
  addTrack({pause:()=>synth.pause&&synth.pause(), play:()=>synth.resume&&synth.resume()});
  await new Promise(res=>{u.onend=res;u.onerror=res; try{synth.speak(u);}catch(_){res();} setTimeout(res,15000);});
}

/* ä¸»æ®µåŸå£°ï¼ˆURLâ†’éšé¡µâ†’assetsâ†’TTSï¼‰ + BGM å‹ä½/æ¢å¤ */
async function playMain(){
  duck(true);
  const ok=await firstPlayable([
    data.voiceUrl, ss('voice_'+key),
    'assets/voice_user.m4a','assets/voice_user.mp3','assets/voice_user.ogg','assets/voice_user.wav',
    'assets/cove_default.m4a','assets/cove_default.mp3','assets/cove_default.ogg','assets/cove_default.wav'
  ],{loop:false,volume:1});
  if(!ok){
    const text=(data.letter||''); 
    if(text.trim()){ await speakTTS(text,(data.reader_gender||'female')); }
    else{ await speakTTS('æ­¤å¤„æ˜¯ä½ çš„åŸå£°çºªå¿µæ®µè½ã€‚ä¸‹æ¬¡å¯åœ¨å…¥å£é¡µé€‰æ‹©â€œåŸå£°æ–‡ä»¶â€æˆ–ç²˜è´´æ–‡å­—ã€‚',(data.reader_gender||'female')); }
  }
  duck(false);
}

/* å€’è®¡æ—¶ï¼ˆä»…æ˜¾ç¤ºï¼‰ */
let paused=false,endAt=0,tickId=null,okFinish=false,closeDone=false;
function startClock(sec){
  endAt=Date.now()+sec*1000;
  function tick(){
    if(paused){ tickId=setTimeout(tick,300); return; }
    const left=Math.max(0,Math.ceil((endAt-Date.now())/1000));
    cdEl.textContent=String(Math.floor(left/60)).padStart(2,'0')+':'+String(left%60).padStart(2,'0');
    if(left===0){ okFinish=true; if(closeDone) __finish(); else tickId=setTimeout(tick,250); }
    else{ tickId=setTimeout(tick,250); }
  }
  if(tickId) clearTimeout(tickId); tick();
}

/* æ’­æ”¾é˜Ÿåˆ—ï¼šä¸¥æ ¼ä¸²è¡Œ */
let Q=Promise.resolve(); function step(fn){ Q=Q.then(fn).catch(()=>{}); return Q; }

/* å½•éŸ³ï¼ˆä¿ç•™ï¼‰ */
let rec=null, recChunks=[], recStream=null, recTimer=null, recStart=0;
function __toggleRec(ev){ev&&ev.stopPropagation(); if(rec&&rec.state==='recording'){__stopRec();return} __startRec();}
function __startRec(){
  __unlock(); const btn=$('recBtn'),info=$('recInfo'); if(info){info.style.display='block';info.textContent='è¯·æ±‚éº¦å…‹é£æƒé™â€¦'}
  let mime=''; try{ if(window.MediaRecorder&&MediaRecorder.isTypeSupported){ if(MediaRecorder.isTypeSupported('audio/mp4')) mime='audio/mp4'; else if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime='audio/webm;codecs=opus'; else if(MediaRecorder.isTypeSupported('audio/webm')) mime='audio/webm'; } }catch(_){}
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    recStream=stream; recChunks=[]; try{rec=new MediaRecorder(stream,mime?{mimeType:mime}:{})}catch(e){rec=new MediaRecorder(stream)}
    rec.ondataavailable=e=>{ if(e.data&&e.data.size>0) recChunks.push(e.data); };
    rec.onstop=()=>{
      try{recStream.getTracks().forEach(t=>t.stop());}catch(_){}
      const blob=new Blob(recChunks,{type:mime||'audio/webm'}); const fr=new FileReader();
      fr.onload=()=>{ try{sessionStorage.setItem('voice_'+key,fr.result);}catch(_){}
        if(info){info.textContent='å·²å½•åˆ¶ '+Math.round((Date.now()-recStart)/1000)+' ç§’ï¼ˆå¼€å§‹åä¼šæ’­æ”¾ï¼‰'} btn.textContent='ğŸ™ï¸ é‡æ–°å½•éŸ³';
      }; fr.readAsDataURL(blob);
    };
    rec.start(200); recStart=Date.now(); btn.textContent='â¹ï¸ åœæ­¢å½•éŸ³'; if(info){info.style.display='block';info.textContent='æ­£åœ¨å½•éŸ³â€¦ æœ€é•¿ 30 ç§’'} recTimer=setTimeout(__stopRec,30000);
  }).catch(()=>{ const info=$('recInfo'); if(info){info.textContent='æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼ˆè¯·åœ¨æµè§ˆå™¨è®¾ç½®é‡Œå…è®¸éº¦å…‹é£ï¼‰'} });
}
function __stopRec(){ const btn=$('recBtn'),info=$('recInfo'); try{rec&&rec.state==='recording'&&rec.stop()}catch(_){}
  if(recTimer){clearTimeout(recTimer);recTimer=null} if(btn) btn.textContent='ğŸ™ï¸ é‡æ–°å½•éŸ³'; if(info){info.style.display='block';info.textContent='å½•éŸ³ç»“æŸ'} }

/* â€”â€” å¼€å§‹ â€”â€” */
async function __start(ev){
  ev&&ev.stopPropagation(); if(window.__started) return; window.__started=true; setDot(true);
  $('hint').style.display='none'; __unlock();

  startClock(Number(data.duration)||180);
  await startBGM();

  const me=(data.yourName||'ä½ '), ai=(data.aiName||'TA');
  const openText=(data.emcee_open||'').replace('{meName}',me).replace('{aiName}',ai);
  const closeText=(data.emcee_close||'');

  // åˆ¤å®šæ˜¯å¦æœ‰â€œå¸ä»ªå¼€åœºéŸ³è½¨â€
  const hasOpenAudio = await firstPlayable(['assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_open.m4a'],{volume:0.001})
                        || await firstPlayable(['assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_open.mp3'],{volume:0.001});

  // 1) å¼€åœºï¼šè§„åˆ™â€”â€”è‹¥æœ‰å¼€åœºéŸ³è½¨ï¼Œåˆ™â€œåªæ’­éŸ³è½¨ï¼Œä¸å†TTSç‚¹åâ€ï¼›å¦åˆ™ TTSï¼ˆç‚¹å+å¼€åœºè¯ï¼‰
  if(hasOpenAudio){
    step(async()=>{ duck(true); await firstPlayable(['assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_open.m4a','assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_open.mp3','assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_open.ogg','assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_open.wav'],{volume:1}); duck(false); });
  }else{
    step(async()=>{ duck(true); await speakTTS(`ç°åœ¨ï¼Œä¸º ${me} ä¸ ${ai} çš„ä»ªå¼å¼€å§‹ã€‚`,(data.emcee_gender||'female')); if(openText.trim()) await speakTTS(openText,(data.emcee_gender||'female')); duck(false); });
  }

  // 2) ä¸»æ®µ
  step(async()=>{ await playMain(); });

  // 3) ç»“å°¾ï¼šåœ¨ç»“æŸå‰ 8~10 ç§’æ’å…¥é˜Ÿåˆ—ï¼›ç­‰å‰é¢æ’­å®Œå†æ’­ï¼Œç»ä¸é‡å 
  const dur=Number(data.duration)||180, CLOSE_BEFORE=dur>=300?10:dur>=180?9:8;
  const ms=Math.max(0,(endAt-Date.now())-CLOSE_BEFORE*1000);
  setTimeout(()=>{
    step(async()=>{ duck(true);
      const ok=await firstPlayable(['assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_close.m4a','assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_close.mp3','assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_close.ogg','assets/emcee_'+((data.emcee_gender||'female')==='male'?'male':'female')+'_close.wav'],{volume:1});
      if(!ok && closeText.trim()) await speakTTS(closeText,(data.emcee_gender||'female'));
      duck(false); closeDone=true; if(okFinish) __finish();
    });
  }, ms);

  if(isReplay){ bump('view_'+cid); }
}

/* æš‚åœ/ç»§ç»­ */
function __pause(){
  if(!paused){ paused=true; $('pause').textContent='ç»§ç»­'; pauseAll(); }
  else{ paused=false; $('pause').textContent='æš‚åœ'; const t=cdEl.textContent.split(':'), left=(parseInt(t[0]||'0')*60+parseInt(t[1]||'0'))||0; endAt=Date.now()+left*1000; resumeAll(); }
}

/* ç»“æŸ */
function __finishNow(){ closeDone=true; okFinish=true; __finish(); }
function __finish(){
  try{bump('finish_'+cid)}catch(_){}
  try{
    AUD.forEach(a=>{ try{
      if(a.loop){ let n=10,step=(a.volume||0)/10; const id=setInterval(()=>{n--; try{a.volume=Math.max(0,(a.volume||0)-step)}catch(_){ } if(n<=0){clearInterval(id); try{a.pause()}catch(_){}}},100); }
      else{ a.pause(); }
    }catch(_){ }});
  }catch(_){}
  location.href='certificate.html#'+location.hash.slice(1);
}

/* åˆ†äº«/æ‰“èµ */
function __landingURL(){ try{ const u=new URL('index.html',location.href).href; return u.replace(/index\.html(\?|#|$)/,'$1'); }catch(e){ return 'index.html'; } }
function __openShare(link,title){ const m=$('shareModal'),i=$('shareInput'),qr=$('shareQR'),t=$('shareTitle'),fb=$('qrFallback'); if(t)t.textContent=title||'åˆ†äº«é“¾æ¥'; if(!m||!i||!qr)return; i.value=link; if(fb)fb.style.display='none';
  const p='https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(link), b='https://quickchart.io/qr?size=240&text='+encodeURIComponent(link);
  qr.onerror=function(){qr.onerror=null;qr.src=b;qr.onload=null;setTimeout(()=>{if(qr.naturalWidth===0&&fb){fb.style.display='flex'}},1000)}; qr.src=p; m.style.display='flex'; __updateShareStats();
}
async function __updateShareStats(){ const el=$('statsLine'); if(!el) return; const v=await readC('view_'+cid), f=await readC('finish_'+cid), t=await readC('tip_open_'+cid); el.textContent='ç´¯è®¡è§‚çœ‹ï¼š'+v+' æ¬¡ Â· å®Œæ’­ï¼š'+f+' æ¬¡ Â· æ‰“èµç‚¹å‡»ï¼š'+t+' æ¬¡'; }
function __copyShare(){ const i=$('shareInput'); if(!i) return; i.select(); i.setSelectionRange(0,99999); try{navigator.clipboard.writeText(i.value).then(()=>alert('å·²å¤åˆ¶é“¾æ¥'))}catch(e){try{document.execCommand('copy');alert('å·²å¤åˆ¶é“¾æ¥')}catch(_){alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰è¾“å…¥æ¡†å¤åˆ¶')}} }
function __shareLanding(){ const link=__landingURL(); try{ if(navigator.share){navigator.share({title:'æƒ…ç»ªåšç‰©é¦†',url:link}).catch(()=>__openShare(link,'é‚€è¯·å¥½å‹æ¥ç©'));} else {__openShare(link,'é‚€è¯·å¥½å‹æ¥ç©');} }catch(_){ __openShare(link,'é‚€è¯·å¥½å‹æ¥ç©'); } }
function __shareReplay(){ const base=location.href.split('#')[0], hash=location.hash.slice(1); const link=base+'#'+(hash?(hash.includes('view=1')?hash:hash+'&view=1'):'view=1'); try{ if(navigator.share){navigator.share({title:'æˆ‘çš„ AI ä»ªå¼ï¼ˆå¯å›æ”¾ï¼‰',url:link}).catch(()=>__openShare(link,'åˆ†äº«å®Œæ•´æµç¨‹'));} else {__openShare(link,'åˆ†äº«å®Œæ•´æµç¨‹');} }catch(_){ __openShare(link,'åˆ†äº«å®Œæ•´æµç¨‹'); } }
function __tip(){ try{bump('tip_open_'+cid)}catch(_){ } const m=$('tipModal'); if(m) m.style.display='flex'; }

/* å¾®ä¿¡å…¼å®¹ */
document.addEventListener('WeixinJSBridgeReady',()=>{try{resumeAll()}catch(_){ } setDot(true)},false);
</script>
</body></html>

