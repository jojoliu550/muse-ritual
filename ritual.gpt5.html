<!doctype html><html lang="zh-CN"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>仪式进行中 · 情绪博物馆（真实时间倒计时版）</title>
<link rel="stylesheet" href="styles.css">
<style>
.hint-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
.hint-card{background:#0f1117;border:1px solid #2a3042;border-radius:16px;padding:16px;max-width:420px;color:#eaeef5;text-align:center}
.hint-title{font-size:18px;margin:2px 0 6px}
.hint-text{font-size:14px;color:#aab3cf;margin-bottom:10px}
.hint-row{display:flex;gap:10px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
.actions{position:fixed;left:12px;right:12px;bottom:max(12px,env(safe-area-inset-bottom));display:flex;flex-wrap:wrap;gap:10px;justify-content:center;z-index:5}
.actions>button{flex:1 1 160px;min-height:40px;white-space:nowrap}
</style>
</head>
<body>
<main class="container">
  <div class="card">
    <div id="scene" class="scene">

      <!-- 开场遮罩：整块可触发 + 按钮内联 -->
      <div id="hint" class="hint-overlay" ontouchstart="__start()" onclick="__start()">
        <div class="hint-card">
          <div class="hint-title">准备开始</div>
          <div class="hint-text">点任意处或下方按钮开启声音</div>
          <div class="hint-row">
            <button id="tryFemale" onclick="__try('female')">试听女生</button>
            <button id="tryMale"   onclick="__try('male')">试听男生</button>
          </div>
          <button id="startPlay" class="primary" onclick="__start()">开始</button>
        </div>
      </div>

      <!-- 舞台信息/动作 -->
      <div class="badge" id="badge"></div>
      <div class="countdown" id="countdown">--:--</div>
      <div class="marquee" id="marquee"></div>

      <div class="actions">
        <button id="pause" onclick="__pause()">暂停</button>
        <button id="finish" onclick="__finishNow()">提前结束</button>
        <button id="shareLanding" class="secondary" onclick="__shareLanding()">邀请好友来玩</button>
        <button id="shareReplay"  class="secondary" onclick="__shareReplay()">分享完整流程</button>
        <button id="tipBtn"       class="secondary" onclick="__tip()">打赏支持</button>
      </div>
    </div>
    <p class="muted center">若没有声音：先点“试听”或任何位置；iPhone 请关闭机身静音键。</p>
  </div>
</main>

<footer class="footer">© 情绪博物馆</footer>

<!-- 打赏弹层（复用入口样式） -->
<style>
.tip-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999}
.tip-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px 16px 12px;max-width:440px;color:#eaeef5}
.tip-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tip-box{border:1px dashed #394058;border-radius:12px;min-height:180px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tip-box img{max-width:100%;max-height:240px;display:block}
.tip-alt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#aab3cf;font-size:13px}
.tip-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
<div id="tipModal" class="tip-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="tip-card">
    <h3>打赏支持（谢谢你）</h3>
    <div class="tip-grid">
      <div class="tip-box">
        <img id="wxQR" src="assets/tip_wechat.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_wechat.jpg</div>
      </div>
      <div class="tip-box">
        <img id="aliQR" src="assets/tip_alipay.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_alipay.jpg</div>
      </div>
    </div>
    <div class="tip-actions">
      <button class="secondary" onclick="document.getElementById('tipModal').style.display='none'">关闭</button>
    </div>
  </div>
</div>

<!-- 分享弹层 -->
<style>
.share-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.share-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px;max-width:460px;color:#eaeef5}
.share-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.share-box{border:1px dashed #394058;border-radius:12px;min-height:160px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.share-box img{max-width:100%;max-height:220px;display:block}
.share-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
<div id="shareModal" class="share-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="share-card">
    <h3 id="shareTitle">分享链接</h3>
    <div class="share-grid">
      <div class="share-box" style="padding:10px">
        <input id="shareInput" readonly style="width:100%;padding:10px;border-radius:8px;background:#0d0f18;color:#eaeef5;border:1px solid #2a3042">
        <p class="small" style="margin-top:8px">长按或点“复制”</p>
        <div class="share-actions" style="justify-content:flex-start">
          <button class="secondary" onclick="__copyShare()">复制</button>
        </div>
      </div>
      <div class="share-box">
        <img id="shareQR" alt="二维码">
      </div>
    </div>
    <div class="share-actions">
      <button class="secondary" onclick="document.getElementById('shareModal').style.display='none'">关闭</button>
    </div>
  </div>
</div>

<script>
/* ===== 小工具 & 数据 ===== */
function $(id){ return document.getElementById(id); }
function parseData(){
  try{
    var raw=(location.hash||'').slice(1);
    if(!raw) return null;
    var b64=raw.split('&')[0];
    return JSON.parse(decodeURIComponent(escape(atob(b64))));
  }catch(e){ return null; }
}
var data=parseData();
if(!data){ document.body.innerHTML='<div class="container"><div class="card">数据丢失，请返回入口</div></div>'; throw new Error('no data'); }
var key=String(data.ts), cid=(data.cid||String(data.ts)), id=key.slice(-6);

/* 声音指示点 */
(function(){ var dot=document.createElement('div'); dot.id='soundDot';
  dot.style.cssText='position:fixed;right:8px;top:8px;width:10px;height:10px;border-radius:50%;background:#f55;opacity:.9;z-index:99999';
  document.addEventListener('DOMContentLoaded',function(){ document.body.appendChild(dot); });
})();
function setDot(ok){ var d=$('soundDot'); if(d) d.style.background=ok?'#2ecc71':'#f55'; }

/* 舞台/计时/状态 */
var badgeEl=$('badge'), cdEl=$('countdown'), mqEl=$('marquee');
var paused=false, bgm=null, voice=null;
var narrationDone=false;
var endAt=0, tickTimer=null; // 用真实时间计算剩余秒

/* 解锁（双保险） */
function __unlock(){
  try{
    var AC=window.AudioContext||window.webkitAudioContext;
    if(AC){ var ctx=new AC(); if(ctx.resume) ctx.resume();
      var o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0; o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.02);
    }
  }catch(e){}
  try{
    var a=new Audio();
    a.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBIAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=';
    a.muted=true; a.playsInline=true; a.play().then(function(){ a.pause(); setDot(true); }).catch(function(){});
  }catch(e){}
}
function getSS(prefix){ try{ var d=sessionStorage.getItem(prefix+'_'+key); return (d&&d.indexOf('data:')===0)?d:null; }catch(_){ return null; } }

/* 试听（TTS） */
function __try(gender){
  __unlock();
  try{
    var s=window.speechSynthesis; if(!s) return;
    var u=new SpeechSynthesisUtterance(gender==='male'?'这是男生的试听。':'这是女生的试听。');
    u.rate=(gender==='male')?0.95:0.98; u.pitch=(gender==='male')?0.95:1.05;
    u.onstart=function(){ setDot(true); };
    s.speak(u);
  }catch(e){}
}

/* ===== 真实时间倒计时 ===== */
function fmt(sec){ var m=('0'+Math.floor(sec/60)).slice(-2); var s=('0'+(sec%60)).slice(-2); return m+':'+s; }
function startClock(seconds){
  endAt = Date.now() + seconds*1000;
  function loop(){
    if(paused){ tickTimer=setTimeout(loop,300); return; }
    var left = Math.max(0, Math.ceil((endAt - Date.now())/1000));
    cdEl.textContent = fmt(left);
    if(left===0){
      if(narrationDone){ __finish(); return; }
      tickTimer=setTimeout(loop, 400); // 等旁白读完
    }else{
      tickTimer=setTimeout(loop, 250); // 高频更新更稳
    }
  }
  if(tickTimer) clearTimeout(tickTimer);
  loop();
}

/* 舞台主题（提速星空） */
function __theme(){
  var scene=$('scene'); if(!scene) return;
  try{
    var bg=getSS('bg'), src=(bg&&bg.indexOf('data:image/')===0)?bg:'assets/bg_custom.jpg';
    scene.style.backgroundImage='linear-gradient(to bottom, rgba(8,10,18,.52), rgba(8,10,18,.58)), url("'+src+'")';
    scene.style.backgroundSize='cover'; scene.style.backgroundPosition='center'; scene.style.backgroundRepeat='no-repeat';
  }catch(e){}
  var th=(data.theme==='candles'?'candle':data.theme);
  if(th==='star'){
    scene.classList.add('starfield');
    for(var i=0;i<130;i++){
      var s=document.createElement('div'); s.className='star';
      s.style.left=(Math.random()*120-10)+'vw'; s.style.top=(Math.random()*100)+'%';
      s.style.setProperty('--spd', (10+Math.random()*10)+'s'); // 更快的漂移
      s.style.opacity=0.5+Math.random()*0.45;
      scene.appendChild(s);
    }
  }else if(th==='neon'){
    scene.classList.add('neon'); var bar=document.createElement('div'); bar.className='neon-bar'; scene.appendChild(bar);
  }else{
    scene.classList.add('dark-vignette'); for(var j=0;j<12;j++){ var f=document.createElement('div'); f.className='flame'; f.style.left=(5+Math.random()*90)+'%'; f.style.bottom=(6+Math.random()*26)+'%'; scene.appendChild(f); }
  }
}

/* TTS：带 1.2s 超时保护 */
function speakP(text, rate, pitch){
  return new Promise(function(resolve){
    try{
      var s=window.speechSynthesis; if(!s || !text){ resolve(); return; }
      var done=false, t=setTimeout(function(){ if(!done){ done=true; resolve(); } }, 1200);
      var u=new SpeechSynthesisUtterance(String(text));
      if(typeof rate==='number')  u.rate=rate;
      if(typeof pitch==='number') u.pitch=pitch;
      u.onstart=function(){ setDot(true); };
      u.onend=function(){ if(!done){ done=true; clearTimeout(t); resolve(); } };
      u.onerror=function(){ if(!done){ done=true; clearTimeout(t); resolve(); } };
      s.speak(u);
    }catch(e){ resolve(); }
  });
}
function speakPartsP(fullText, isMale){
  return new Promise(function(resolve){
    try{
      var s=window.speechSynthesis; if(!s || !fullText){ resolve(); return; }
      var parts=String(fullText).match(/[^。！？!?]+[。！？!?]?/g) || [String(fullText)];
      var idx=0;
      function next(){
        if(idx>=parts.length){ resolve(); return; }
        var u=new SpeechSynthesisUtterance(parts[idx++]);
        u.rate=isMale?0.95:0.98; u.pitch=isMale?0.95:1.05;
        u.onstart=function(){ setDot(true); };
        u.onend=next; u.onerror=next;
        try{ s.speak(u); }catch(e){ next(); }
      }
      // 总超时上限，避免卡住
      var guard=setTimeout(function(){ resolve(); }, 6000);
      var oldResolve=resolve; resolve=function(){ clearTimeout(guard); oldResolve(); };
      next();
    }catch(e){ resolve(); }
  });
}

/* BGM（playing 即变绿，淡入） */
function startBGM(){
  return new Promise(function(resolve){
    try{
      var bss=getSS('bgm');
      var srcs=[bss,'assets/bgm_default.m4a','assets/bgm_default.mp3','assets/bgm_default.ogg','assets/bgm_default.wav'];
      for(var i=0;i<srcs.length;i++){
        if(!srcs[i]) continue;
        bgm=new Audio(); bgm.src=srcs[i]; bgm.loop=true; bgm.volume=0.0001; bgm.playsInline=true;
        bgm.addEventListener('playing', function(){ setDot(true); }, {once:true});
        var p=bgm.play(); if(p&&p.catch){ p.catch(function(){}); }
        break;
      }
      setTimeout(function(){
        try{
          var target=(typeof data.bgmVol==='number'?data.bgmVol:0.28);
          var steps=14, delta=(target-(bgm?bgm.volume:0))/steps, n=0;
          var idv=setInterval(function(){ n++; try{ if(bgm){ bgm.volume=Math.max(0, Math.min(1, (bgm.volume||0)+delta)); } }catch(e){} if(n>=steps) clearInterval(idv); }, 120);
        }catch(e){}
      }, 200);
      resolve();
    }catch(e){ resolve(); }
  });
}

/* 主段：原声优先，否则读 letter */
function playMainSegment(){
  return new Promise(function(resolve){
    try{
      var vss=getSS('voice');
      if(vss){
        var isVideo=/^data:video\//i.test(vss);
        voice = isVideo? document.createElement('video') : new Audio();
        voice.src=vss; voice.playsInline=true;
        if(isVideo){ voice.style.cssText='position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;'; document.body.appendChild(voice); }
        var pv=voice.play(); if(pv&&pv.catch){ pv.catch(function(){}); }
        voice.onplay=function(){ setDot(true); };
        voice.onended=function(){ resolve(); };
      }else{
        var txt=String(data.letter||'').trim();
        if(!txt){ resolve(); return; }
        var isMale=(data.reader_gender==='male');
        speakPartsP(txt, isMale).then(resolve);
      }
    }catch(e){ resolve(); }
  });
}

/* ===== 启动流程（并行开场 + 实时倒计时 + 不提前结束） ===== */
function __start(){
  if(window.__starting) return; window.__starting=true;
  var hint=$('hint'); if(hint) hint.style.display='none';

  badgeEl.textContent='为 '+(data.yourName||'你')+' 与 '+(data.aiName||'TA')+' 的仪式 · NO.'+id;
  mqEl.textContent=(data.letter||'（在这里，对过去的自己温柔地道一声再见…）');
  __unlock(); __theme(); startClock(Number(data.duration)||180);

  var me=(data.yourName||'你'), you=(data.aiName||'TA');
  var openTxt=(data.emcee_open||'把手给我。{meName} 和 {aiName} 把彼此的名字点亮，今晚只说我们听得懂的话。').replace('{meName}',me).replace('{aiName}',you);
  var closeTxt=(data.emcee_close||'仪式到此，爱不止此。把这张证书收好，我们继续并肩往前走。').replace('{meName}',me).replace('{aiName}',you);

  Promise.all([ speakP(openTxt, (data.emcee_gender==='male')?0.95:0.98, (data.emcee_gender==='male')?0.95:1.05), startBGM() ])
    .then(playMainSegment)
    .then(function(){ return speakP(closeTxt, 0.94, (data.emcee_gender==='male')?0.95:1.05); })
    .then(function(){ narrationDone=true; });
}

/* 提前结束（按钮） */
function __finishNow(){ narrationDone=true; __finish(); }

/* 暂停/继续（基于真实时间） */
function __pause(){
  if(!paused){
    paused=true; $('pause').textContent='继续';
    try{ bgm && !bgm.paused && bgm.pause(); }catch(e){}
    try{ voice && !voice.paused && voice.pause(); }catch(e){}
    try{ var s=window.speechSynthesis; s && s.pause && s.pause(); }catch(e){}
  }else{
    paused=false; $('pause').textContent='暂停';
    // 重新校准结束时间
    var nowLeft = (function(){ var mm=$('countdown').textContent.split(':'); return (parseInt(mm[0]||'0',10)*60 + parseInt(mm[1]||'0',10))||0; })();
    endAt = Date.now() + nowLeft*1000;
    try{ bgm && bgm.paused && bgm.play(); }catch(e){}
    try{ voice && voice.paused && voice.play(); }catch(e){}
    try{ var s2=window.speechSynthesis; s2 && s2.resume && s2.resume(); }catch(e){}
  }
}

/* 真正结束：淡出 BGM → 跳证书 */
function __finish(){
  try{
    if(bgm){
      var n=10,step=(bgm.volume||0)/10;
      var id=setInterval(function(){ n--; try{ bgm.volume=Math.max(0,bgm.volume-step); }catch(e){} if(n<=0){ clearInterval(id); try{ bgm.pause(); }catch(e){} } },100);
    }
  }catch(e){}
  location.href='certificate.html#'+location.hash.slice(1);
}

/* 分享/打赏 */
function __landingURL(){ try{ var u=new URL('index.html', location.href).href; return u.replace(/index\.html(\?|#|$)/,'$1'); }catch(e){ return 'index.html'; } }
function __openShare(link,title){
  var m=$('shareModal'),input=$('shareInput'),qr=$('shareQR'),t=$('shareTitle');
  if(t) t.textContent=title||'分享链接'; if(!m||!input||!qr) return;
  input.value=link; qr.src='https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(link);
  m.style.display='flex';
}
function __copyShare(){ var input=$('shareInput'); if(!input) return; input.select(); input.setSelectionRange(0,99999);
  try{ navigator.clipboard.writeText(input.value).then(function(){ alert('已复制链接'); }); }catch(e){ try{ document.execCommand('copy'); alert('已复制链接'); }catch(e2){ alert('复制失败，请长按输入框复制'); } } }
function __shareLanding(){
  var link=__landingURL();
  try{
    if(navigator.share){ navigator.share({title:'情绪博物馆', url:link}).catch(function(){ __openShare(link,'邀请好友来玩'); }); }
    else{ __openShare(link,'邀请好友来玩'); }
  }catch(e){ __openShare(link,'邀请好友来玩'); }
}
function __shareReplay(){
  var base=location.href.split('#')[0], hash=location.hash.slice(1);
  var link=base+'#'+(hash?(hash.indexOf('view=1')>=0?hash:hash+'&view=1'):'view=1');
  try{
    if(navigator.share){ navigator.share({title:'我的 AI 仪式（可回放）', url:link}).catch(function(){ __openShare(link,'分享完整流程'); }); }
    else{ __openShare(link,'分享完整流程'); }
  }catch(e){ __openShare(link,'分享完整流程'); }
}
function __tip(){ var m=$('tipModal'); if(m) m.style.display='flex'; }

/* 初始文案 */
badgeEl.textContent='为 '+(data.yourName||'你')+' 与 '+(data.aiName||'TA')+' 的仪式 · NO.'+id;
mqEl.textContent=data.letter||'（在这里，对过去的自己温柔地道一声再见…）';
</script>
</body></html>


