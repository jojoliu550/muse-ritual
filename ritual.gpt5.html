<!doctype html><html lang="zh-CN"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>仪式进行中 · 情绪博物馆（v4.5 名字先念版）</title>
<link rel="stylesheet" href="styles.css">
<style>
.hint-overlay{position:fixed;inset:0;background:rgba(0,0,0,.50);display:flex;align-items:center;justify-content:center;z-index:9999}
.hint-card{background:#0f1117;border:1px solid #2a3042;border-radius:16px;padding:16px;max-width:480px;color:#eaeef5;text-align:center;max-height:72vh;overflow:auto}
.hint-title{font-size:18px;margin:2px 0 8px}
.hint-text{font-size:14px;color:#aab3cf;margin-bottom:12px}
.hint-row{display:flex;gap:10px;justify-content:center;margin-bottom:10px;flex-wrap:wrap}
.hint-row button{min-width:150px}
.actions{position:fixed;left:12px;right:12px;bottom:max(12px,env(safe-area-inset-bottom));display:flex;flex-wrap:wrap;gap:10px;justify-content:center;z-index:5}
.actions>button{flex:1 1 160px;min-height:40px;white-space:nowrap}
.small{font-size:12px;color:#aab3cf}
</style>
</head>
<body>
<main class="container">
  <div class="card">
    <div id="scene" class="scene">
      <!-- 开场遮罩 -->
      <div id="hint" class="hint-overlay" onclick="__maskTap(event)">
        <div class="hint-card" onclick="event.stopPropagation()">
          <div class="hint-title">准备开始</div>
          <div class="hint-text">点空白处或“开始”授权音频；安卓/微信请先点一次“试听”再开始</div>
          <div class="hint-row">
            <button onclick="__beep(event)">试听女生</button>
            <button onclick="__beep(event)">试听男生</button>
            <button id="recBtn" onclick="__toggleRec(event)">🎙️ 录音我的原声（上限30秒）</button>
          </div>
          <div id="recInfo" class="small" style="display:none"></div>
          <button id="startPlay" class="primary" onclick="__start(event)">开始</button>
          <div class="small" style="margin-top:6px">说明：录音仅保存在本机临时内存，不上传</div>
        </div>
      </div>

      <!-- 舞台信息/动作 -->
      <div class="badge" id="badge"></div>
      <div class="countdown" id="countdown">--:--</div>
      <div class="marquee" id="marquee"></div>

      <div class="actions">
        <button id="pause" onclick="__pause()">暂停</button>
        <button id="finish" onclick="__finishNow()">提前结束</button>
        <button id="shareLanding" class="secondary" onclick="__shareLanding()">邀请好友来玩</button>
        <button id="shareReplay"  class="secondary" onclick="__shareReplay()">分享完整流程</button>
        <button id="tipBtn"       class="secondary" onclick="__tip()">打赏支持</button>
      </div>
    </div>
    <p class="muted center">若没有声音：先点“试听”或空白处；iPhone 请关闭机身静音键。</p>
  </div>
</main>
<footer class="footer">© 情绪博物馆</footer>

<!-- 打赏弹层 -->
<style>
.tip-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:99999}
.tip-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px 16px 12px;max-width:440px;color:#eaeef5}
.tip-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tip-box{border:1px dashed #394058;border-radius:12px;min-height:180px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tip-box img{max-width:100%;max-height:240px;display:block}
.tip-alt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#aab3cf;font-size:13px}
.tip-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
<div id="tipModal" class="tip-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="tip-card">
    <h3>打赏支持（谢谢你）</h3>
    <div class="tip-grid">
      <div class="tip-box">
        <img id="wxQR" src="assets/tip_wechat.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_wechat.jpg</div>
      </div>
      <div class="tip-box">
        <img id="aliQR" src="assets/tip_alipay.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_alipay.jpg</div>
      </div>
    </div>
    <div class="tip-actions">
      <button class="secondary" onclick="document.getElementById('tipModal').style.display='none'">关闭</button>
    </div>
  </div>
</div>

<!-- 分享弹层 -->
<style>
.share-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.share-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px;max-width:480px;color:#eaeef5}
.share-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.share-box{border:1px dashed #394058;border-radius:12px;min-height:160px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.share-box img{max-width:100%;max-height:220px;display:block}
.share-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
<div id="shareModal" class="share-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="share-card">
    <h3 id="shareTitle">分享链接</h3>
    <div class="share-grid">
      <div class="share-box" style="padding:10px">
        <input id="shareInput" readonly style="width:100%;padding:10px;border-radius:8px;background:#0d0f18;color:#eaeef5;border:1px solid #2a3042">
        <p class="small" style="margin-top:8px">长按或点“复制”</p>
        <div class="share-actions" style="justify-content:flex-start">
          <button class="secondary" onclick="__copyShare()">复制</button>
        </div>
      </div>
      <div class="share-box">
        <img id="shareQR" alt="二维码">
        <div id="qrFallback" class="small" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center">二维码加载失败，请先复制链接</div>
      </div>
    </div>
    <div id="statsLine" class="small" style="margin-top:10px;text-align:center">累计观看：-- 次 · 完播：-- 次 · 打赏点击：-- 次</div>
    <div class="share-actions">
      <button class="secondary" onclick="document.getElementById('shareModal').style.display='none'">关闭</button>
    </div>
  </div>
</div>

<script>
/* ===== 工具与数据 ===== */
function $(id){return document.getElementById(id)}
function parseData(){try{const raw=(location.hash||'').slice(1);if(!raw)return null;const b64=raw.split('&')[0];return JSON.parse(decodeURIComponent(escape(atob(b64))))}catch(e){return null}}
const data=parseData(); if(!data){ document.body.innerHTML='<div class="container"><div class="card">数据丢失，请返回入口</div></div>'; throw new Error('no data'); }
const key=String(data.ts), cid=(data.cid||String(data.ts)), id=key.slice(-6), isReplay=(location.hash||'').includes('view=1');

/* 计数 */
const NS='muse-ritual';
function bump(n){try{fetch('https://api.countapi.xyz/hit/'+NS+'/'+encodeURIComponent(n))}catch(e){}}
async function readC(n){try{const r=await fetch('https://api.countapi.xyz/get/'+NS+'/'+encodeURIComponent(n));const j=await r.json();return j&&typeof j.value==='number'?j.value:0}catch(e){return 0}}

/* 右上角指示点 */
(function(){const d=document.createElement('div');d.id='soundDot';d.style.cssText='position:fixed;right:8px;top:8px;width:10px;height:10px;border-radius:50%;background:#f55;opacity:.9;z-index:99999';document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(d));})();
function setDot(ok){const d=$('soundDot');if(d)d.style.background=ok?'#2ecc71':'#f55'}

/* 舞台文字 */
const badgeEl=$('badge'), cdEl=$('countdown'), mqEl=$('marquee');
badgeEl.textContent='为 '+(data.yourName||'你')+' 与 '+(data.aiName||'TA')+' 的仪式 · NO.'+id;
mqEl.textContent=data.letter||'（在这里，对过去的自己温柔地道一声再见…）';

/* 统一音轨池（暂停/继续可控） */
const AUD=new Set();
function addAudio(a){if(!a)return;AUD.add(a);a.addEventListener('ended',()=>AUD.delete(a));}
function pauseAll(){AUD.forEach(a=>{try{!a.paused&&a.pause()}catch(_){}}); try{speechSynthesis&&speechSynthesis.pause&&speechSynthesis.pause()}catch(_){}}
function resumeAll(){AUD.forEach(a=>{try{a.paused&&a.play()}catch(_){}}); try{speechSynthesis&&speechSynthesis.resume&&speechSynthesis.resume()}catch(_){}}

/* 星空背景（保持流动） */
(function theme(){
  const scene=$('scene'); if(!scene) return;
  const custom = data.bgImageUrl || (function(){try{return sessionStorage.getItem('bg_'+key)||''}catch(_){return ''}})();
  if(custom){ scene.style.backgroundImage='linear-gradient(to bottom, rgba(24,26,36,.30), rgba(24,26,36,.40)), url("'+custom+'")'; scene.style.backgroundSize='cover'; scene.style.backgroundPosition='center'; }
  const th=(data.theme==='candles'?'candle':data.theme);
  if(th==='star'){ scene.classList.add('starfield'); for(let i=0;i<140;i++){const s=document.createElement('div');s.className='star';s.style.left=(Math.random()*120-10)+'vw';s.style.top=(Math.random()*100)+'%';s.style.setProperty('--spd',(9+Math.random()*11)+'s');s.style.opacity=0.55+Math.random()*0.4;scene.appendChild(s);} }
  else if(th==='neon'){ scene.classList.add('neon'); const bar=document.createElement('div'); bar.className='neon-bar'; scene.appendChild(bar); }
  else{ scene.classList.add('dark-vignette'); }
})();

/* 解锁 + 试听 */
function __unlock(){
  try{const AC=window.AudioContext||window.webkitAudioContext;if(AC){const ctx=new AC();ctx.resume&&ctx.resume();const b=ctx.createBuffer(1,1,22050),src=ctx.createBufferSource();src.buffer=b;src.connect(ctx.destination);src.start(0);}}catch(_){}
  try{const a=new Audio();a.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBIAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=';a.muted=true;a.playsInline=true;a.play().then(()=>{a.pause();setDot(true);}).catch(()=>{});}catch(_){}
}
function __beep(ev){ev&&ev.stopPropagation();__unlock(); try{const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return;const ctx=new AC();const o=ctx.createOscillator(),g=ctx.createGain();o.type='sine';o.frequency.value=880;g.gain.value=0.25;o.connect(g).connect(ctx.destination);o.start();setDot(true);setTimeout(()=>{try{o.stop();ctx.close&&ctx.close();}catch(_){}},180);}catch(_){}}
function __maskTap(e){ if(e && e.target && e.target.id==='hint'){ __start(e); } }

/* 资源选择（优先使用入口页传来的远程 URL） */
async function pickPlayable(srcs,{loop=false,vol=1,prewarm=false}={}){
  for(const s of srcs){ if(!s) continue; const a=new Audio(); a.src=s; a.preload='auto'; a.playsInline=true; a.loop=!!loop; a.volume=vol;
    if(prewarm){ a.muted=true; try{ await a.play(); a.pause(); a.muted=false; return a; }catch{ continue; } }
    try{ await a.play(); a.pause(); return a; }catch{ } }
  return null;
}

let bgm=null, emceeOpen=null, emceeClose=null;
async function prewarmAll(){
  const ssBgm=(function(){try{return sessionStorage.getItem('bgm_'+key)||''}catch(_){return ''}})();
  const bgmSrc=[ data.bgmUrl, ssBgm, 'assets/bgm_default.m4a','assets/bgm_default.mp3','assets/bgm_default.ogg','assets/bgm_default.wav' ];
  bgm=await pickPlayable(bgmSrc,{loop:true,vol:0.0001});
  if(bgm){ addAudio(bgm); try{await bgm.play();}catch(_){ } setTimeout(()=>{try{let t=(typeof data.bgmVol==='number'?data.bgmVol:0.28),n=14;const step=(t-(bgm.volume||0))/n;const id=setInterval(()=>{n--;try{bgm.volume=Math.min(t,(bgm.volume||0)+step);}catch(_){ } if(n<=0)clearInterval(id);},120);}catch(_){ }},200); setTimeout(()=>{try{bgm&&bgm.paused&&bgm.play()}catch(_){ }},600); setTimeout(()=>{try{bgm&&bgm.paused&&bgm.play()}catch(_){ }},1200); }
  const g=(data.emcee_gender||'female')==='male'?'male':'female';
  emceeOpen = await pickPlayable(['assets/emcee_'+g+'_open.m4a','assets/emcee_'+g+'_open.mp3','assets/emcee_'+g+'_open.ogg','assets/emcee_'+g+'_open.wav'],{prewarm:true});
  emceeClose= await pickPlayable(['assets/emcee_'+g+'_close.m4a','assets/emcee_'+g+'_close.mp3','assets/emcee_'+g+'_close.ogg','assets/emcee_'+g+'_close.wav'],{prewarm:true});
}

/* 主段原声：URL → 随页 → assets 兜底 → TTS 文字 */
async function playMainOrTTS(){
  const ssV=(function(){try{return sessionStorage.getItem('voice_'+key)||''}catch(_){return ''}})();
  const cand=[ data.voiceUrl, ssV, 'assets/voice_user.m4a','assets/voice_user.mp3','assets/voice_user.ogg','assets/voice_user.wav', 'assets/cove_default.m4a','assets/cove_default.mp3','assets/cove_default.ogg','assets/cove_default.wav' ];
  for(const s of cand){
    if(!s) continue;
    const a=new Audio(); a.src=s; a.playsInline=true; addAudio(a);
    try{ await a.play(); await new Promise(r=>a.onended=r); return; }catch(_){ }
  }
  await speakTTS(data.letter||'', (data.reader_gender||'female'));
}

/* TTS（加缓冲，避免吞字） */
async function speakTTS(text,pref){
  const synth=window.speechSynthesis; if(!synth || !text) return;
  try{synth.resume&&synth.resume();}catch(_){}
  await new Promise(r=>setTimeout(r,100)); // 关键缓冲
  function choose(){
    const list=synth.getVoices()||[]; const want=(pref==='male')?['Tao','Daniel','Alex','Google US English','Google Mandarin']:['Xiaoxiao','Xiaoyi','Yating','Samantha','Google 中文','Google Mandarin'];
    for(const w of want){ const hit=list.find(v=>(v.name||'').toLowerCase().includes(w.toLowerCase())); if(hit) return hit; }
    return list[0]||null;
  }
  const u=new SpeechSynthesisUtterance(text); const v=choose(); if(v){u.voice=v;u.lang=v.lang||'zh-CN';} else {u.lang='zh-CN'}
  u.rate=(pref==='male'?0.95:0.98); u.pitch=(pref==='male'?0.96:1.04);
  addAudio({pause:()=>synth.pause&&synth.pause(), play:()=>synth.resume&&synth.resume()}); // 让暂停键可控
  await new Promise(res=>{u.onend=res;u.onerror=res; try{synth.speak(u);}catch(_){res();} setTimeout(res,15000);});
}

/* 倒计时（解耦，保证显示） */
let paused=false,endAt=0,tickId=null,closing=false,narrationDone=false;
function startClock(seconds){
  endAt=Date.now()+seconds*1000;
  function tick(){
    if(paused){ tickId=setTimeout(tick,300); return; }
    const left=Math.max(0,Math.ceil((endAt-Date.now())/1000));
    cdEl.textContent=String(Math.floor(left/60)).padStart(2,'0')+':'+String(left%60).padStart(2,'0');
    const CLOSE_BEFORE=seconds>=300?10:seconds>=180?9:8;
    if(!closing && left<=CLOSE_BEFORE){
      closing=true;(async()=>{ const e=emceeClose; if(e){ addAudio(e); try{await e.play()}catch(_){ } } narrationDone=true; })();
    }
    if(left===0){ if(narrationDone){ __finish(); return; } tickId=setTimeout(tick,300); }
    else{ tickId=setTimeout(tick,250); }
  }
  if(tickId) clearTimeout(tickId); tick();
}

/* 录音（保留） */
let rec=null, recChunks=[], recStream=null, recTimer=null, recStart=0;
function __toggleRec(ev){ev&&ev.stopPropagation(); if(rec&&rec.state==='recording'){__stopRec();return} __startRec();}
function __startRec(){
  __unlock(); const btn=$('recBtn'),info=$('recInfo'); if(info){info.style.display='block';info.textContent='请求麦克风权限…'}
  let mime=''; try{ if(window.MediaRecorder&&MediaRecorder.isTypeSupported){ if(MediaRecorder.isTypeSupported('audio/mp4')) mime='audio/mp4'; else if(MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) mime='audio/webm;codecs=opus'; else if(MediaRecorder.isTypeSupported('audio/webm')) mime='audio/webm'; } }catch(_){}
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    recStream=stream; recChunks=[]; try{rec=new MediaRecorder(stream,mime?{mimeType:mime}:{})}catch(e){rec=new MediaRecorder(stream)}
    rec.ondataavailable=e=>{ if(e.data&&e.data.size>0) recChunks.push(e.data); };
    rec.onstop=()=>{
      try{recStream.getTracks().forEach(t=>t.stop());}catch(_){}
      const blob=new Blob(recChunks,{type:mime||'audio/webm'}); const fr=new FileReader();
      fr.onload=()=>{ try{sessionStorage.setItem('voice_'+key,fr.result);}catch(_){}
        if(info){info.textContent='已录制 '+Math.round((Date.now()-recStart)/1000)+' 秒（开始后会播放）'} btn.textContent='🎙️ 重新录音';
      }; fr.readAsDataURL(blob);
    };
    rec.start(200); recStart=Date.now(); btn.textContent='⏹️ 停止录音'; if(info){info.style.display='block';info.textContent='正在录音… 最长 30 秒'} recTimer=setTimeout(__stopRec,30000);
  }).catch(()=>{ const info=$('recInfo'); if(info){info.textContent='无法获取麦克风权限（请在浏览器设置里允许麦克风）'} });
}
function __stopRec(){ const btn=$('recBtn'),info=$('recInfo'); try{rec&&rec.state==='recording'&&rec.stop()}catch(_){}
  if(recTimer){clearTimeout(recTimer);recTimer=null} if(btn) btn.textContent='🎙️ 重新录音'; if(info){info.style.display='block';info.textContent='录音结束'} }

/* —— 关键改动：开始流程（先“点名”） —— */
async function __start(ev){
  ev&&ev.stopPropagation(); if(window.__started) return; window.__started=true; setDot(true);
  const hint=$('hint'); if(hint) hint.style.display='none';
  __unlock();

  await prewarmAll();                        // 预热音轨
  startClock(Number(data.duration)||180);    // 先启动倒计时，保证不再 --:--

  const me=(data.yourName||'你'), ai=(data.aiName||'TA');
  const openText=(data.emcee_open||'').replace('{meName}',me).replace('{aiName}',ai);

  // 1) 必读“点名”
  try{ await speakTTS(`现在，为 ${me} 与 ${ai} 的仪式开始。`, data.emcee_gender||'female'); }catch(_){}

  // 2) 开场司仪：有音轨就播；没有就用 TTS 读开场词
  if(emceeOpen){ addAudio(emceeOpen); try{ await emceeOpen.play(); }catch(_){ } }
  else{ try{ await speakTTS(openText, data.emcee_gender||'female'); }catch(_){} }

  // 3) 主段原声或 TTS 文字
  await playMainOrTTS();

  if(isReplay){ bump('view_'+cid); }
}

/* 暂停/继续 */
function __pause(){
  if(!paused){ paused=true; $('pause').textContent='继续'; pauseAll(); }
  else{ paused=false; $('pause').textContent='暂停';
    const t=$('countdown').textContent.split(':'), left=(parseInt(t[0]||'0')*60+parseInt(t[1]||'0'))||0;
    endAt=Date.now()+left*1000; resumeAll();
  }
}

/* 结束 */
function __finishNow(){ closing=true; narrationDone=true; __finish(); }
function __finish(){
  try{bump('finish_'+cid)}catch(_){}
  try{ if(bgm){ let n=10,step=(bgm.volume||0)/10; const id=setInterval(()=>{n--;try{bgm.volume=Math.max(0,(bgm.volume||0)-step)}catch(_){ } if(n<=0){clearInterval(id); try{bgm.pause()}catch(_){}}},100); } }catch(_){}
  location.href='certificate.html#'+location.hash.slice(1);
}

/* 分享与统计 */
function __landingURL(){ try{ const u=new URL('index.html',location.href).href; return u.replace(/index\.html(\?|#|$)/,'$1'); }catch(e){ return 'index.html'; } }
function __openShare(link,title){ const m=$('shareModal'),i=$('shareInput'),qr=$('shareQR'),t=$('shareTitle'),fb=$('qrFallback'); if(t)t.textContent=title||'分享链接'; if(!m||!i||!qr)return; i.value=link; if(fb)fb.style.display='none';
  const p='https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(link);
  const b='https://quickchart.io/qr?size=240&text='+encodeURIComponent(link);
  qr.onerror=function(){qr.onerror=null;qr.src=b;qr.onload=null;setTimeout(()=>{if(qr.naturalWidth===0&&fb){fb.style.display='flex'}},1000)};
  qr.src=p; m.style.display='flex'; __updateShareStats();
}
async function __updateShareStats(){ const el=$('statsLine'); if(!el) return; const v=await readC('view_'+cid), f=await readC('finish_'+cid), t=await readC('tip_open_'+cid); el.textContent='累计观看：'+v+' 次 · 完播：'+f+' 次 · 打赏点击：'+t+' 次'; }
function __copyShare(){ const i=$('shareInput'); if(!i) return; i.select(); i.setSelectionRange(0,99999);
  try{navigator.clipboard.writeText(i.value).then(()=>alert('已复制链接'))}catch(e){try{document.execCommand('copy');alert('已复制链接')}catch(_){alert('复制失败，请长按输入框复制')}} }
function __shareLanding(){ const link=__landingURL(); try{ if(navigator.share){navigator.share({title:'情绪博物馆',url:link}).catch(()=>__openShare(link,'邀请好友来玩'));} else {__openShare(link,'邀请好友来玩');} }catch(_){ __openShare(link,'邀请好友来玩'); } }
function __shareReplay(){ const base=location.href.split('#')[0], hash=location.hash.slice(1); const link=base+'#'+(hash?(hash.includes('view=1')?hash:hash+'&view=1'):'view=1'); try{ if(navigator.share){navigator.share({title:'我的 AI 仪式（可回放）',url:link}).catch(()=>__openShare(link,'分享完整流程'));} else {__openShare(link,'分享完整流程');} }catch(_){ __openShare(link,'分享完整流程'); } }
function __tip(){ try{bump('tip_open_'+cid)}catch(_){ } const m=$('tipModal'); if(m) m.style.display='flex'; }

/* 微信内核兼容 */
document.addEventListener('WeixinJSBridgeReady',()=>{try{resumeAll()}catch(_){ } setDot(true)},false);
</script>
</body></html>

