<!doctype html><html lang="zh-CN"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>仪式证书 · 情绪博物馆（含浏览量统计）</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<main class="container">
  <div class="card">
    <h2>纪念证书</h2>
    <p id="c-badge" class="muted"></p>
    <div class="certificate">
      <h3>你的原文</h3>
      <pre id="c-text" style="white-space:pre-wrap"></pre>
      <p id="c-extra" class="small muted"></p>
      <p id="c-stats" class="small muted">统计：--</p>
    </div>
    <div class="actions">
      <button id="shareReplay" class="secondary">分享完整流程</button>
      <button id="tipBtn" class="secondary">打赏支持</button>
    </div>
  </div>
</main>
<footer class="footer">© 情绪博物馆</footer>

<!-- 打赏弹层（复用 ritual 的样式） -->
<style>
.tip-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.tip-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px 16px 12px;max-width:440px;color:#eaeef5}
.tip-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tip-box{border:1px dashed #394058;border-radius:12px;min-height:180px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tip-box img{max-width:100%;max-height:240px;display:block}
.tip-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
</style>
<div id="tipModal" class="tip-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="tip-card">
    <h3>打赏支持（谢谢你）</h3>
    <div class="tip-grid">
      <div class="tip-box">
        <img id="wxQR" src="assets/tip_wechat.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_wechat.jpg</div>
      </div>
      <div class="tip-box">
        <img id="aliQR" src="assets/tip_alipay.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_alipay.jpg</div>
      </div>
    </div>
    <div class="tip-actions">
      <button class="secondary" onclick="document.getElementById('tipModal').style.display='none'">关闭</button>
    </div>
  </div>
</div>

<script>
function parseData(){ try{ const raw=(location.hash||'').slice(1); if(!raw) return null; const b64=raw.split('&')[0]; return JSON.parse(decodeURIComponent(escape(atob(b64)))); }catch(e){ return null; } }
const data=parseData(); if(!data){ document.body.innerHTML='<div class="container"><div class="card">数据丢失，请返回入口</div></div>'; throw new Error('no data'); }
const key=String(data.ts), id=key.slice(-6), cid=(data.cid||String(data.ts));

document.getElementById('c-badge').textContent = `为 ${(data.yourName||'你')} 与 ${(data.aiName||'TA')} 的仪式 · NO.${id}`;
document.getElementById('c-text').textContent  = data.letter || '（无文字）';
document.getElementById('c-extra').textContent = `主题：${data.theme} · 时长：${data.duration||180} 秒 · 司仪：${data.emcee_gender==='male'?'男':'女'} · 阅读者：${data.reader_gender==='male'?'男':'女'}`;

/* 匿名计数器（与 ritual 保持一致命名） */
const NS='muse-ritual';
async function readCount(name){ try{ const r=await fetch('https://api.countapi.xyz/get/'+NS+'/'+encodeURIComponent(name)); const j=await r.json(); return j && typeof j.value==='number'?j.value:0; }catch(e){ return 0; } }
function bump(name){ try{ fetch('https://api.countapi.xyz/hit/'+NS+'/'+encodeURIComponent(name)); }catch(e){} }

/* 刷新三项统计 */
async function updateStats(){
  const v = await readCount('view_'+cid);
  const f = await readCount('finish_'+cid);
  const t = await readCount('tip_open_'+cid);
  const el=document.getElementById('c-stats');
  el.textContent = `统计：观看 ${v} · 完播 ${f} · 打赏点击 ${t}`;
}
updateStats();

/* 分享/打赏 */
function shareReplay(){
  const base='ritual.gpt5.html', hash=location.hash.slice(1);
  const link=base+'#'+(hash?(hash.includes('view=1')?hash:hash+'&view=1'):'view=1');
  if(navigator.share){ navigator.share({title:'我的 AI 仪式（回放）', url:link}).catch(()=>copy(link)); }
  else copy(link);
}
function copy(text){ try{ navigator.clipboard.writeText(text).then(()=>alert('已复制链接')); }catch(_){ prompt('复制链接', text); } }
function openTip(){ bump('tip_open_'+cid); const m=document.getElementById('tipModal'); if(m) m.style.display='flex'; }

document.getElementById('shareReplay')?.addEventListener('click', shareReplay);
document.getElementById('tipBtn')?.addEventListener('click', openTip);
</script>
</body></html>
