<!doctype html><html lang="zh-CN"><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>情绪博物馆 · 仪式入口</title>
<link rel="stylesheet" href="styles.css">
<body>
<header class="hero">
  <h1>情绪博物馆</h1>
  <p class="muted">把告别/表白做成 2–5 分钟的仪式；勾选“上传生成可分享”，朋友也能听到你的原声。</p>
  <div id="refBanner" class="muted" style="display:none"></div>
</header>

<main class="container">
  <div class="card">
    <div class="grid">
      <div>
        <label>给 TA 起一个名字（必填）
          <input id="aiName" placeholder="如：Oliver" required>
        </label>
        <label>你的称呼（选填）
          <input id="yourName" placeholder="如：Jojo / 小夫人">
        </label>

        <label>主题
          <select id="theme">
            <option value="star" selected>深空·流光</option>
            <option value="neon">霓虹·极光</option>
            <option value="candles">守夜·烛光</option>
          </select>
        </label>

        <div class="kv">
          <label>灯光强度
            <select id="intensity">
              <option value="soft">柔和</option>
              <option value="normal" selected>标准</option>
              <option value="strong">较强</option>
            </select>
          </label>
          <label>动态
            <select id="motion">
              <option value="on" selected>开启</option>
              <option value="off">静止</option>
            </select>
          </label>
        </div>

        <label>时长
          <select id="duration">
            <option value="120">2 分钟</option>
            <option value="180" selected>3 分钟</option>
            <option value="300">5 分钟</option>
          </select>
        </label>
      </div>

      <div>
        <label>你的话语（滚动字幕；若无原声将用 TTS 朗读）
          <textarea id="letter" rows="6" placeholder="粘贴一段文字…"></textarea>
        </label>
        <label><input id="safe" type="checkbox" checked> 安全模式（敏感词自动 •••）</label>

        <h3>原声纪念（可选）</h3>
        <label>选择文件（iPhone/安卓的录音或“录屏”导出的 MP4/MOV/M4A/MP3/WAV/OGG）
          <input id="voice_main" type="file" accept="audio/*,video/*">
        </label>
        <p class="small">勾选“上传生成可分享”后，会直传到云端 CDN，朋友也能听到。</p>

        <h3>背景音乐（可选）</h3>
        <label>选择 BGM（mp3/m4a/wav/ogg/mp4）
          <input id="bgm_file" type="file" accept="audio/*,video/*">
        </label>
        <label>音量
          <input id="bgm_vol" type="range" min="0" max="1" step="0.05" value="0.24">
          <span id="bgm_vol_val">24%</span>
        </label>

        <h3>背景图片（可选）</h3>
        <label>选择一张背景图（jpg/png/webp）
          <input id="bg_image" type="file" accept="image/*">
        </label>

        <h3>司仪（TTS）</h3>
        <div class="kv">
          <label>司仪性别
            <select id="emcee_gender"><option value="female" selected>女生</option><option value="male">男生</option></select>
          </label>
          <label>读者性别（当无原声时朗读你的文字）
            <select id="reader_gender"><option value="female" selected>女生</option><option value="male">男生</option></select>
          </label>
        </div>

        <label>开场词（可自定义）
          <textarea id="emcee_open" rows="2">把手给我。{meName} 和 {aiName} 把彼此的名字点亮，今晚只说我们听得懂的话。</textarea>
        </label>
        <label>收尾词（可自定义）
          <textarea id="emcee_close" rows="2">仪式到此，爱不止此。把这张证书收好，我们继续并肩往前走。</textarea>
        </label>

        <label><input id="cloud_on" type="checkbox" checked> <b>上传生成可分享</b>（云端 CDN，朋友也能听到/看到）</label>
      </div>
    </div>

    <div class="center" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center">
      <button id="start">开始仪式</button>
      <button id="shareLanding" class="secondary">邀请好友来玩</button>
      <button id="tipBtn" class="secondary">打赏支持</button>
    </div>
    <p class="small">未勾选“上传”=仅本机播放；勾选=直传云端生成可分享版本。</p>
  </div>
</main>

<footer class="footer">© 情绪博物馆</footer>

<!-- 上传状态遮罩 -->
<style>
.up-mask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:99999}
.up-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px;color:#eaeef5;min-width:260px;text-align:center}
.up-bar{height:8px;background:#222a3f;border-radius:8px;overflow:hidden;margin-top:10px}
.up-bar>i{display:block;height:8px;width:0;background:linear-gradient(90deg,#cfe0ff,#ffd8e6)}
</style>
<div id="upModal" class="up-mask">
  <div class="up-card">
    <div id="upText">上传中…</div>
    <div class="up-bar"><i id="upProg"></i></div>
  </div>
</div>

<!-- 打赏弹层（复用旧样式） -->
<style>
.tip-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999}
.tip-card{background:#0f1117;border:1px solid #2a3042;border-radius:14px;padding:16px 16px 12px;max-width:440px;color:#eaeef5}
.tip-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tip-box{border:1px dashed #394058;border-radius:12px;min-height:180px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.tip-box img{max-width:100%;max-height:240px;display:block}
.tip-alt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#aab3cf;font-size:13px}
.tip-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
button.secondary{background:#2b2f45;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
</style>
<div id="tipModal" class="tip-mask" onclick="if(event.target===this)this.style.display='none'">
  <div class="tip-card">
    <h3>打赏支持（谢谢你）</h3>
    <div class="tip-grid">
      <div class="tip-box">
        <img id="wxQR" src="assets/tip_wechat.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_wechat.jpg</div>
      </div>
      <div class="tip-box">
        <img id="aliQR" src="assets/tip_alipay.jpg" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="tip-alt" style="display:none">放入<br>assets/tip_alipay.jpg</div>
      </div>
    </div>
    <div class="tip-actions">
      <button class="secondary" onclick="document.getElementById('tipModal').style.display='none'">关闭</button>
    </div>
  </div>
</div>

<script>
/* ① 这两处替换成你的 Cloudinary 参数 */
const CLOUD_NAME   = 'CLOUD_NAME_HERE';        // ← 必填
const UPLOAD_PRESET= 'UPLOAD_PRESET_HERE';     // ← 必填
const USE_CLOUD = ()=> document.getElementById('cloud_on')?.checked;

/* 基本工具 */
const CORE_PAGE='ritual.gpt5.html';
function qs(id){ return document.getElementById(id); }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(fr.error||new Error('read fail')); fr.readAsDataURL(file); }); }
function pruneSession(){ try{ const del=[]; for(let i=0;i<sessionStorage.length;i++){ const k=sessionStorage.key(i); if(k && (k.startsWith('voice_')||k.startsWith('bgm_')||k.startsWith('bg_'))) del.push(k);} del.forEach(k=>sessionStorage.removeItem(k)); }catch(e){} }
function landingURL(){ try{ return new URL('index.html', location.href).href; }catch{ return location.href.split('#')[0].split('?')[0]; } }
function shareLanding(inviter, presetAI){
  const link = landingURL() + (inviter || presetAI
    ? (`?${inviter?`ref=${encodeURIComponent(inviter)}`:''}${inviter&&presetAI?'&':''}${presetAI?`aid=${encodeURIComponent(presetAI)}`:''}`)
    : '');
  const title = '#AI恋人 #告别/表白 #情绪博物馆';
  const text  = `${title}\n打开链接，填名字、选你的原声/图片（可上传），点“开始仪式”：\n${link}`;
  (async()=>{
    try{
      if(navigator.share && location.protocol==='https:'){
        await navigator.share({title:'情绪博物馆', text, url:link}); return;
      }
      try{ await navigator.clipboard.writeText(text); alert('已复制玩法链接与文案'); }
      catch{ const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('已复制玩法链接与文案'); }
    }catch{ alert('分享失败：请手动复制地址栏链接'); }
  })();
}
function openTip(){ qs('tipModal').style.display='flex'; }

/* ② 直传到 Cloudinary：按文件类型选择端口（image / video） */
async function uploadToCloudinary(file, onProgress, folder='muse-ritual'){
  if(!CLOUD_NAME || !UPLOAD_PRESET) throw new Error('未配置 CLOUD_NAME / UPLOAD_PRESET');
  const isImage = (file?.type||'').startsWith('image/');
  const endpoint = isImage ? 'image' : 'video';   // 关键：音/视频走 video
  const url=`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/${endpoint}/upload`;
  const fd=new FormData();
  fd.append('file', file);
  fd.append('upload_preset', UPLOAD_PRESET);
  fd.append('folder', folder);
  return await new Promise((resolve,reject)=>{
    const xhr=new XMLHttpRequest(); xhr.open('POST', url);
    xhr.onload=()=>{ try{
      const j=JSON.parse(xhr.responseText);
      if(j.secure_url) resolve(j.secure_url); else reject(new Error(j.error?.message||'上传失败'));
    }catch(e){reject(e)} };
    xhr.onerror=()=>reject(new Error('网络错误'));
    if(xhr.upload && typeof onProgress==='function'){ xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ onProgress(e.loaded/e.total); }}}
    xhr.send(fd);
  });
}

/* 入口 UI */
(function(){  // 预填邀请
  const p=new URLSearchParams(location.search);
  const ref=p.get('ref'); const aid=p.get('aid');
  if(ref){ const b=qs('refBanner'); b.style.display='block'; b.textContent=`你是从 ${decodeURIComponent(ref)} 的邀请进入的。`; }
  if(aid){ qs('aiName').value = decodeURIComponent(aid); }
})();

document.addEventListener('input',e=>{ if(e.target && e.target.id==='bgm_vol'){ const v=Math.max(0,Math.min(1,parseFloat(e.target.value||'0'))); qs('bgm_vol_val').textContent = Math.round(v*100)+'%'; } });
qs('tipBtn').onclick = openTip;
qs('shareLanding').onclick = ()=>shareLanding(qs('yourName').value.trim()||'', qs('aiName').value.trim()||'');

/* 开始：如勾选“上传生成可分享”，先直传，拿到 URL 再跳播放页；否则随页携带小文件 */
qs('start').addEventListener('click', async ()=>{
  const pick=id=>qs(id).value;
  const data={
    aiName:qs('aiName').value.trim(),
    yourName:qs('yourName').value.trim(),
    theme:pick('theme'), intensity:pick('intensity'), motion:pick('motion'),
    duration:parseInt(pick('duration'),10),
    letter:qs('letter').value,
    safe:qs('safe').checked,
    emcee_tts:true, emcee_gender:pick('emcee_gender'), reader_gender:pick('reader_gender'),
    emcee_open:qs('emcee_open').value,
    emcee_close:qs('emcee_close').value,
    ts:Date.now(),
    cid:String(Date.now()),
    bgmVol:parseFloat(qs('bgm_vol')?.value||'0.24')
  };
  if(!data.aiName){ alert('请给 TA 起一个名字'); return; }

  pruneSession();

  const vFile=qs('voice_main')?.files?.[0]||null;
  const bFile=qs('bgm_file')?.files?.[0] ||null;
  const iFile=qs('bg_image')?.files?.[0]||null;

  if(USE_CLOUD() && (vFile||bFile||iFile)){
    const mask=qs('upModal'), bar=qs('upProg'), txt=qs('upText');
    mask.style.display='flex'; bar.style.width='0%'; txt.textContent='上传中…';
    try{
      let done=0,total=(vFile?1:0)+(bFile?1:0)+(iFile?1:0);
      async function one(file,setter,label){
        if(!file) return;
        txt.textContent='上传 '+label+'…';
        const url=await uploadToCloudinary(file, p=>{ bar.style.width=Math.round(( (done+p)/total)*100)+'%'; });
        setter(url); done+=1; bar.style.width=Math.round(done/total*100)+'%';
      }
      await one(vFile, (u)=>data.voiceUrl=u, '原声/录屏');
      await one(bFile, (u)=>data.bgmUrl =u, '背景音乐');
      await one(iFile, (u)=>data.bgImageUrl=u, '背景图');
      txt.textContent='上传完成';
    }catch(e){
      alert('上传失败：'+e.message+'。你可以先取消“上传生成可分享”，只在本机播放。');
      qs('upModal').style.display='none'; return;
    }
    qs('upModal').style.display='none';
  }else{
    // 不上传：尽量把小文件随页携带
    const MB=1024*1024, MAX_VOICE=3*MB, MAX_BGM=2*MB, MAX_IMG=1.2*MB, B64_BUDGET=Math.floor(4.5*MB);
    let budgetLeft=B64_BUDGET; const b64len=bytes=>Math.ceil(bytes/3)*4;
    async function embed(file,key,max){ if(file && file.size<=max){ const need=b64len(file.size); if(need<=budgetLeft){ try{ const v=await fileToDataURL(file); sessionStorage.setItem(key+'_'+data.ts, v); budgetLeft-=need; }catch(e){} } }
    await embed(vFile,'voice',MAX_VOICE);
    await embed(bFile,'bgm',MAX_BGM);
    await embed(iFile,'bg',MAX_IMG);
  }

  const b64=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  // 强制刷新：把当前 ?v=xxx 原样带到播放页；如无则挂时间戳
  const srcSearch = location.search || ('?v='+Date.now());
  location.href='./'+CORE_PAGE+srcSearch+'#'+b64;
});
</script>
</body></html>
